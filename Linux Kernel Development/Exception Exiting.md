# Unix环境进程异常退出
进程退出意味着进程生命期的结束，系统资源被回收，进程从操作系统环境中销毁。进程异常退出是进程在运行过程中被意外终止，从而导致进程本来应该继续执行的任务无法完成。

进程异常退出可能给软件用户造成如下负面影响：
- 软件丧失部分或者全部功能性，无法完成既定任务。
- 如果进程正在处理数据，可能造成数据损坏。
- 如果是关键软件服务，必然导致服务异常中止, 造成无法预计的损失。
- 进程异常退出或者进程崩溃, 也会给软件用户造成恐慌和困惑。

所有可能造成进程异常退出的原因归结为两类：
- 向进程发送信号导致进程异常退出
- 代码错误导致进程运行时异常退出(此类错误最终转化为第一类)

## 1. 向进程发送信号导致进程异常退出
信号
- UNIX 系统中的信号是系统响应某些状况而产生的事件，是进程间通信的一种方式。信号可以由一个进程发送给另外进程，也可以由核发送给进程。

信号处理程序
- 信号处理程序是进程在接收到信号后，系统对信号的响应。根据具体信号的涵义，相应的默认信号处理程序会采取不同的信号处理方式：
    - 终止进程运行，并且产生core dump文件
    - 终止进程运行
    - 忽略信号，进程继续执行
    - 暂停进程运行
    - 如果进程已被暂停，重新调度进程继续执行

前两种方式会导致进程异常退出，在进程接收到信号后，如果进程已经绑定自定义的信号处理程序，进程会在用户态执行自定义的信号处理程序；反之，内核会执行默认信号程序终止进程运行，导致进程异常退出。所以，通过向进程发送信号可以触发默认信号处理程序，默认信号处理程序终止进程运行。在 UNIX 环境中我们有三种方式将信号发送给目标进程，导致进程异常退出。
- 调用函数kill()发送信号
    - 调用函数 kill() 后，进程进入内核态向目标进程发送指定信号；目标进程在接收到信号后，默认信号处理程序被调用，进程异常退出
- 运行kill命令发送信号
    - kill 命令也是调用 kill 系统调用函数来发送信号
- 在终端使用键盘发送信号
    - 用户还可以在终端用键盘输入特定的字符（比如 control-C 或 control-\）向前台进程发送信号，终止前台进程运行。常见的中断字符组合是，使用 control-C 发送 SIGINT 信号，使用 control-\ 发送 SIGQUIT 信号，使用 control-z 发送 SIGTSTP 信号。在实现上，当用户输入中断字符组合时，比如 control-C，终端驱动程序响应键盘输入，并且识别 control-C 是信号 SIGINT 的产生符号，然后向前台进程发送 SIGINT 信号。当前台进程再次被调用时就会接收到 SIGINT 信号

## 2. 编程错误导致进程运行时异常退出
操作系统和计算机硬件约束每个进程的行为，使进程运行在用户态空间，控制权限，确保进程不会破坏系统资源，不会干涉进入其它进程的空间，确保进程合法访问内存。当进程尝试突破禁区做非法操作时，系统会立刻觉察，并且终止进程运行。在实现上，操作系统和计算机硬件通过异常和异常处理函数来阻止进程做非法操作。

## 2.1 异常和异常处理函数
当进程执行非法操作时，计算机会抛出处理器异常，系统执行异常处理函数以响应处理器异常，异常处理函数往往会终止进程运行。

广义的异常包括软中断 (soft interrupts) 和外设中断 (I/O interrupts) 。外设中断是系统外围设备发送给处理器的中断，它通知处理器 I/O 操作的状态，这种异常是外设的异步异常，与具体进程无关，所以它们不会造成进程的异常退出。soft interrupts是进程非法操作所导致的处理器异常，这类异常是进程执行非法操作所产生的同步异常，比如内存保护异常，除0异常，缺页异常等等。

处理器异常有很多种，系统为每个异常分配异常号，每个异常有相对应的异常处理函数。以 x86 处理器为例，除 0 操作产生 DEE 异常 (Divide Error Exception)，异常号是 0；内存非法访问产生 GPF 异常 (General Protection Fault)，异常号是 13，而缺页 (page fault) 异常的异常号是 14。当异常出现时，处理器挂起当前进程，读取异常号，然后执行相应的异常处理函数。如果异常是可修复，比如内存缺页异常，异常处理函数会修复系统错误状态，清除异常，然后重新执行一遍被中断的指令，进程继续运行；如果异常无法修复，比如内存非法访问或者除 0 操作，异常处理函数会终止进程运行

## 2.2 异常处理函数内幕
异常处理函数在实现上，是通过向挂起进程发送信号，进而通过信号的默认信号处理程序终止进程运行，所以异常处理函数是“间接”终止进程运行。详细过程如下：
- 进程执行非法指令或执行错误操作
- 非法操作导致处理器异常产生
- 系统挂起进程，读取异常号并且跳转到相应的异常处理函数
    - 异常处理函数首先查看异常是否可以恢复。如果无法恢复异常，异常处理函数向进程发送信号。发送的信号根据异常类型而定，比如内存保护异常 GPF 相对应的信号是 SIGSEGV，而除 0 异常 DEE 相对应的信号是 SIGFPE
    - 异常处理函数调用内核函数 issig() 和 psig() 来接收和处理信号。内核函数 psig() 执行默认信号处理程序，终止进程运行
- 进程异常退出

# 3. 信号是进程异常退出的原因
信号与进程异常退出有着紧密的关系：
- 第一类情况是因为外部环境向进程发送信号，这种情况下发送的信号是异步信号，信号的到来与进程的运行是异步的
- 第二类情况是进程非法操作触发处理器异常，然后异常处理函数在内核态向进程发送信号，这种情况下发送的信号是同步信号，信号的到来与进程的运行是同步的。

这两种情况都有信号产生，并且最终都是信号处理程序终止进程运行。它们的区别是信号产生的信号源不同，前者是外部信号源产生异步信号，后者是进程自身作为信号源产生同步信号。

所以，信号是进程异常退出的直接原因。当进程异常退出时，进程必然接收到了信号。

# 4. 资源回收和释放
进程在正常退出时可以调用对象相关的析构函数来释放资源，在异常退出时无法调用这些析构函数，但是现在知道异常退出时是信号引起的，那么就可以自定义信号处理函数，受到异常信号在退出之前，释放所有已经持有的资源，保证资源正确释放和回收，避免遗留无法回收和认领的系统资源。这样一来，无论进程怎么退出，资源都能得到正确的释放。
